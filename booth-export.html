<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="What's in Your Hand?" />
  <title>拍貼｜輸出與列印</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    /* Base */
    html, body { margin:0; background:#fff; color:#1f2a33; overscroll-behavior:none; touch-action:manipulation; }
    *{ box-sizing:border-box; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    body { font-family:"Manrope","Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    /* Fullscreen stage scaled to 1366x1024 like other pages */
    :root{ --vh:1vh; --_scale:1; }
    .outer{ width:100vw; height:100vh; display:grid; place-items:center; overflow:hidden; background:#fff; }
    .outer.use-vh-var{ height:calc(var(--vh) * 100); }
    .fit{ width:1366px; height:1024px; transform:translateZ(0) scale(var(--_scale)); transform-origin:center; }

    /* Layout: left buttons, right merged preview */
    .stage{ position:relative; width:100%; height:100%; padding:80px; display:grid; grid-template-columns: 360px 1fr; gap:48px; }
    .left{ display:flex; flex-direction:column; gap:18px; align-items:stretch; justify-content:center; }
    .btn{
      appearance:none; border:0; border-radius:18px;
      padding:18px 24px; font-weight:900; font-size:24px; cursor:pointer;
      background:#bfefff; color:#1f2a33;
      box-shadow:0 6px 0 rgba(0,0,0,.12), 0 12px 32px rgba(0,0,0,.06);
      transition:transform .08s ease, background .15s ease, box-shadow .15s ease;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{ background:#a8e6ff; transform:translateY(-1px); box-shadow:0 7px 0 rgba(0,0,0,.12), 0 14px 36px rgba(0,0,0,.08); }
    .btn:active{ transform:translateY(1px); box-shadow:0 3px 0 rgba(0,0,0,.1); }

    .right{ display:grid; align-content:center; justify-items:center; }
    .frame{
      width:min(80%, 720px);
      aspect-ratio: 3 / 4;         /* 預覽比例：合併後為直式 */
      border-radius:20px;
      display:grid; place-items:center;
      background:#f6fbff;
      border:2px solid #dfeff9;
      box-shadow:0 10px 0 rgba(0,0,0,.06), 0 18px 44px rgba(0,0,0,.08);
      padding:18px;
    }
    .preview{
      display:block; width:100%; height:100%; object-fit:contain; border-radius:12px; background:#fff;
    }
    .hint{ margin-top:14px; font-weight:800; color:#6b7076; letter-spacing:.2px; }

    /* Printing: only print the merged image, fill page width while keeping aspect */
    @media print {
      body, .outer, .fit, .stage { padding:0; margin:0; background:#fff !important; box-shadow:none !important; }
      .left, .hint, .frame{ display:none !important; }
      .print-only{ display:block !important; }
      img#printImage{
        display:block !important;
        width:100% !important;
        height:auto !important;
        page-break-inside:avoid;
      }
    }
    /* Hidden print image by default */
    .print-only{ display:none; }
  </style>
</head>
<body>
  <div class="outer">
    <div class="fit">
      <div class="stage">
        <aside class="left">
          <button id="retake" class="btn">↩️ 重新拍一次</button>
          <button id="print" class="btn">🖨️ 列印</button>
        </aside>

        <section class="right">
          <div class="frame">
            <img id="preview" class="preview" alt="合併預覽（上下拼接）" />
          </div>
          <div class="hint" id="hint">合併中⋯</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Print-only merged image -->
  <img id="printImage" class="print-only" alt="Merged Photo" />

  <script>
    // scale stage to viewport (iPad safe)
    (function(){
      function setVH(){
        var h = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
        document.documentElement.style.setProperty('--vh', (h*0.01)+'px');
        var s = Math.min(window.innerWidth/1366, h/1024);
        document.documentElement.style.setProperty('--_scale', s);
      }
      setVH();
      addEventListener('resize', setVH, {passive:true});
      addEventListener('orientationchange', setVH);
      addEventListener('pageshow', setVH);
      document.addEventListener('DOMContentLoaded', ()=>{
        document.querySelectorAll('.outer').forEach(n=>n.classList.add('use-vh-var'));
      }, {passive:true});
    })();

    const previewImg = document.getElementById('preview');
    const printImg = document.getElementById('printImage');
    const hint = document.getElementById('hint');

    function readShots(){
      try{
        const raw = localStorage.getItem('photobooth_shots');
        if(!raw) return null;
        const o = JSON.parse(raw);
        if(!o || !o.one || !o.two) return null;
        return o;
      }catch(e){ return null; }
    }

    // Merge two dataURLs vertically (top-bottom). Keep max width of the two, total height sum.
    async function mergeVertical(srcTop, srcBottom){
      // load images
      const load = (src)=> new Promise((res, rej)=>{
        const img = new Image();
        img.onload = ()=>res(img);
        img.onerror = rej;
        img.src = src;
      });
      const top = await load(srcTop);
      const bot = await load(srcBottom);

      const w = Math.max(top.naturalWidth || top.width, bot.naturalWidth || bot.width);
      const h = (top.naturalHeight || top.height) + (bot.naturalHeight || bot.height);

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');

      // draw with white background to avoid black when printing JPEG
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, w, h);

      // scale each to full width, keep aspect
      const drawScaled = (img, y0)=>{
        const iw = img.naturalWidth || img.width;
        const ih = img.naturalHeight || img.height;
        const s = w / iw;
        const dh = Math.round(ih * s);
        ctx.drawImage(img, 0, 0, iw, ih, 0, y0, w, dh);
        return dh;
      };
      let y = 0;
      y += drawScaled(top, y);
      y += drawScaled(bot, y);

      // export (use JPEG 0.92 like capture)
      return canvas.toDataURL('image/jpeg', 0.92);
    }

    async function init(){
      const shots = readShots();
      if(!shots){
        hint.textContent = '找不到照片，請返回重新拍攝。';
        previewImg.alt = '沒有可合併的照片';
        return;
      }
      try{
        const merged = await mergeVertical(shots.one, shots.two);
        previewImg.src = merged;
        printImg.src = merged;
        hint.textContent = '預覽完成。';
        // 也存一份給其他頁面使用
        localStorage.setItem('photobooth_merged', merged);
      }catch(e){
        console.error(e);
        hint.textContent = '合併失敗，請重新拍攝。';
      }
    }

    // Buttons
    document.getElementById('retake').addEventListener('click', ()=>{
      // 回到拍攝頁
      window.location.href = 'booth-duo-ipad.html';
    });
    document.getElementById('print').addEventListener('click', ()=>{
      // 直接觸發列印（@media print 只輸出圖片）
      window.print();
    });

    init();
  </script>
</body>
</html>
