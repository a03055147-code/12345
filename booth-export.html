<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Export</title>
<style>
  html,body{margin:0;background:#fff;height:100%}
  body{display:grid;place-items:center}
  canvas{width:min(90vw,900px);height:auto;display:block}
  @media print{
    html,body{background:#fff}
    canvas{width:100vw;max-width:100vw;height:auto}
  }
</style>
</head>
<body>
  <canvas id="out"></canvas>
<script>
// ======= Config =======
const TEMPLATE_SRC = '心理測驗套版.png';
const MARGIN_X = 0.08;        // 左右內縮比例
const MARGIN_Y_TOP = 0.08;     // 上內縮比例
const MARGIN_Y_BOTTOM = 0.08;  // 下內縮比例
const MID_BAR = 0.08;          // 中間橫條厚度比例
const SLOT_RADIUS_PX = 24;     // 視窗圓角

// ======= Load shots from localStorage =======
let shots = null;
try{
  const json = localStorage.getItem('photobooth_shots');
  shots = json ? JSON.parse(json) : null;
}catch(e){}

if(!shots || !shots.one || !shots.two){
  // 若沒有照片就直接返回拍攝頁
  location.replace('booth-duo-ipad.html');
}

const tpl = new Image(); tpl.src = TEMPLATE_SRC;
const topImg = new Image(); topImg.src = shots.one;
const bottomImg = new Image(); bottomImg.src = shots.two;

Promise.all([
  new Promise(r=>tpl.onload=r),
  new Promise(r=>topImg.onload=r),
  new Promise(r=>bottomImg.onload=r),
]).then(()=>{
  const c = document.getElementById('out');
  const ctx = c.getContext('2d');

  const W = tpl.naturalWidth, H = tpl.naturalHeight;
  c.width = W; c.height = H;

  // 背景白
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,W,H);

  const innerX = W * MARGIN_X;
  const innerW = W * (1 - MARGIN_X*2);
  const innerYTop = H * MARGIN_Y_TOP;
  const innerYBot = H * (1 - MARGIN_Y_BOTTOM);
  const barH = H * MID_BAR;

  const slotH = (innerYBot - innerYTop - barH) / 2;
  const slot1 = { x: innerX, y: innerYTop, w: innerW, h: slotH };
  const slot2 = { x: innerX, y: innerYTop + slotH + barH, w: innerW, h: slotH };

  function roundRectPath(r, radius){
    const rr = Math.max(0, radius);
    ctx.beginPath();
    ctx.moveTo(r.x+rr, r.y);
    ctx.lineTo(r.x+r.w-rr, r.y);
    ctx.quadraticCurveTo(r.x+r.w, r.y, r.x+r.w, r.y+rr);
    ctx.lineTo(r.x+r.w, r.y+r.h-rr);
    ctx.quadraticCurveTo(r.x+r.w, r.y+r.h, r.x+r.w-rr, r.y+r.h);
    ctx.lineTo(r.x+rr, r.y+r.h);
    ctx.quadraticCurveTo(r.x, r.y+r.h, r.x, r.y+r.h-rr);
    ctx.lineTo(r.x, r.y+rr);
    ctx.quadraticCurveTo(r.x, r.y, r.x+rr, r.y);
    ctx.closePath();
  }

  function drawCover(img, r){
    const imgW = img.naturalWidth || 1, imgH = img.naturalHeight || 1;
    const s = Math.max(r.w/imgW, r.h/imgH);
    const dw = imgW*s, dh = imgH*s;
    const dx = r.x + (r.w - dw)/2;
    const dy = r.y + (r.h - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  const radius = SLOT_RADIUS_PX * (Math.min(W,H)/1200);

  // 上窗
  ctx.save(); roundRectPath(slot1, radius); ctx.clip(); drawCover(topImg, slot1); ctx.restore();
  // 下窗
  ctx.save(); roundRectPath(slot2, radius); ctx.clip(); drawCover(bottomImg, slot2); ctx.restore();

  // 疊上模板
  ctx.drawImage(tpl, 0, 0, W, H);
}).catch(()=>{
  location.replace('booth-duo-ipad.html');
});
</script>
</body>
</html>
